# Lab 4 运行指南

## 方法一：使用启动脚本（推荐，macOS）

```bash
# 1. 给脚本添加执行权限
chmod +x run.sh

# 2. 运行脚本（会自动打开5个终端窗口）
./run.sh

# 3. 等待几秒让所有节点启动完成
```

## 方法二：手动启动（推荐，所有平台）

### 步骤1: 启动5个节点

打开5个终端窗口（Terminal），在每个窗口中运行：

**终端1 - node1:**
```bash
cd /Users/lupeipei/PycharmProjects/PythonProject/lab4
python3 start_node.py --node-id node1
```

**终端2 - node2:**
```bash
cd /Users/lupeipei/PycharmProjects/PythonProject/lab4
python3 start_node.py --node-id node2
```

**终端3 - node3:**
```bash
cd /Users/lupeipei/PycharmProjects/PythonProject/lab4
python3 start_node.py --node-id node3
```

**终端4 - node4:**
```bash
cd /Users/lupeipei/PycharmProjects/PythonProject/lab4
python3 start_node.py --node-id node4
```

**终端5 - node5:**
```bash
cd /Users/lupeipei/PycharmProjects/PythonProject/lab4
python3 start_node.py --node-id node5
```

### 步骤2: 等待节点启动

等待几秒钟，你会看到类似这样的输出：
```
[node1] Starting node on localhost:5001
[node1] Node listening on localhost:5001, state: FOLLOWER
```

### 步骤3: 运行客户端命令

打开**新的终端窗口**，运行客户端命令：

#### 测试场景1: 正常流程（Write → Quorum → Commit）

```bash
# 1. 客户端1设置初始target
python3 client.py --client-id client1 --node node1 --command write --value 50

# 2. 客户端2从不同节点读取（验证一致性）
python3 client.py --client-id client2 --node node2 --command read
python3 client.py --client-id client3 --node node3 --command read
```

#### 测试场景2: 猜测流程（Multiple Guesses → Leader选择最接近的）

```bash
# 1. 设置初始target
python3 client.py --client-id client1 --node node1 --command write --value 50

# 等待2秒让系统完成提交

# 2. 多个客户端提交猜测
python3 client.py --client-id client2 --node node2 --command guess --value 45
python3 client.py --client-id client3 --node node3 --command guess --value 55
python3 client.py --client-id client4 --node node4 --command guess --value 60
python3 client.py --client-id client5 --node node5 --command guess --value 48

# 3. 触发处理猜测（写入新target会自动处理之前的猜测）
python3 client.py --client-id client1 --node node1 --command write --value 75

# 4. 验证结果（应该看到最接近50的猜测被选为新target）
python3 client.py --client-id client2 --node node2 --command read
```

#### 测试场景3: Leader崩溃和恢复

```bash
# 1. 先运行一些操作
python3 client.py --client-id client1 --node node1 --command write --value 50
python3 client.py --client-id client2 --node node2 --command guess --value 45

# 2. 找到哪个节点是Leader（查看节点终端窗口的输出）
# 3. 在Leader节点的终端窗口中按 Ctrl+C 杀死Leader

# 4. 等待几秒，系统会自动选举新Leader（查看其他节点的输出）

# 5. 继续运行操作（应该正常工作）
python3 client.py --client-id client3 --node node3 --command read
python3 client.py --client-id client4 --node node4 --command write --value 60
```

## 快速测试脚本

你也可以使用demo脚本快速测试：

```bash
# 确保所有5个节点都在运行
python3 demo.py
```

## 常见问题

### 1. 端口被占用
如果看到 "Address already in use" 错误：
```bash
# 检查端口占用
lsof -i :5001
lsof -i :5002
# ... 等等

# 或者修改 config.py 中的端口号
```

### 2. 节点无法连接
- 确保所有5个节点都在运行
- 检查防火墙设置
- 确保在同一台机器上运行（localhost）

### 3. 清除日志（重新开始）
```bash
# 删除所有日志数据库文件
rm logs_*.db
```

### 4. 查看节点状态
查看每个节点的终端窗口输出，可以看到：
- 当前状态（FOLLOWER/CANDIDATE/LEADER）
- 收到的消息
- 提交的操作
- 选举过程

## 预期输出示例

### 节点输出示例：
```
[node1] Starting node on localhost:5001
[node1] Node listening on localhost:5001, state: FOLLOWER
[node1] Becoming LEADER (epoch: 0)
[node1] Collected guess: 45 from client2
[node1] Processing guesses: target=50, guesses=[45, 55, 60], closest=48
[node1] Applied WRITE: target = 50
```

### 客户端输出示例：
```
[Client client1] Connected to node1 at localhost:5001
[Client client1] Write successful: target = 50
[Client client2] Current target: 50
```

## 停止系统

在每个节点的终端窗口中按 `Ctrl+C` 停止节点。

